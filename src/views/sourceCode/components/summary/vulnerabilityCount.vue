<template>
  <div>
    <a-card title="缺陷统计">
      <a-row>
        <a-col :span="24">
          <div>
            <div v-show="timeData.length !== 0" ref="singleProjectChart" style="height:218px;"></div>
            <div v-show="visible" style="height: 218px; text-align:center; line-height:218px;"><h3>暂无数据</h3></div>
          </div>
        </a-col>
      </a-row>
    </a-card>
  </div>
</template>

<script>
  import echarts from 'echarts'
  import debounce from 'lodash/debounce'   //防抖
  import {addListener, removeListener} from 'resize-detector' //echart 位置


  export default {
    name: "singleProjectChart",
    props: {
      timeData: {
        type: Array,
        required: true
      },
      startValue: {
        type: String,
        required: true
      },
      singleCriticalData: {
        type: Array,
        required: true
      },
      singleHighData: {
        type: Array,
        required: true
      },
      singleMediumData: {
        type: Array,
        required: true
      },
      singleLowData: {
        type: Array,
        required: true
      },
      loading: {
        type: Boolean,
        required: true,
      },
      visible: {
        type: Boolean,
        required: true,
      },

    },
    //深度监听chart Data 的变化
    watch: {
      timeData: {
        handler(val) {
          this.option.xAxis.data = val;
          this.renderChart();
        },
        deep: true
      },
      startValue: {
        handler(val) {
          this.option.dataZoom[0].startValue = val;
          this.renderChart();
        },
        deep: true
      },
      singleCriticalData: {
        handler(val) {
          this.option.series[0].data = val;
          this.renderChart();
        },
        deep: true
      },
      singleHighData: {
        handler(val) {
          this.option.series[1].data = val;
          this.renderChart();
        },
        deep: true
      },
      singleMediumData: {
        handler(val) {
          this.option.series[2].data = val;
          this.renderChart();
        },
        deep: true
      },
      singleLowData: {
        handler(val) {
          this.option.series[3].data = val;
          this.renderChart();
        },
        deep: true
      },
    },
    data() {
      return {
        chart: null,
        option: {
          tooltip: {
            trigger: 'axis'
          },
          color: ['#c23531', '#d48265', '#2f4554', '#61a0a8'],
          legend: {
            data: ['危', '高', '中', '低'],
            orient: 'vertical',
            x: 'left',
          },
          grid: {
            left: '10%',
            top: "5%",
            right: '5%',
            bottom: '18%',
            containLabel: true
          },
          xAxis: {
            type: 'category',
            data: this.timeData,
            axisTick: {
              alignWithLabel: true
            },
          },
          yAxis: {
            splitLine: {
              show: false
            }
          },
          dataZoom: [{
            startValue: this.startValue
          }, {
            type: 'inside'
          }],

          series: [
            {
              name: '危',
              type: 'bar',
              stack: '总量',
              areaStyle: {},
              data: this.singleCriticalData
            },
            {
              name: '高',
              type: 'bar',
              stack: '总量',
              areaStyle: {},
              data: this.singleHighData
            },
            {
              name: '中',
              type: 'bar',
              stack: '总量',
              areaStyle: {},
              data: this.singleMediumData
            },
            {
              name: '低',
              type: 'bar',
              stack: '总量',
              areaStyle: {},
              data: this.singleLowData
            }
          ]
        }
      }
    },
    created() {
      this.resize = debounce(this.resize, 300);//防抖
    },
    mounted() {
      this.renderChart();
      addListener(this.$refs.singleProjectChart, this.resize);
    },
    methods: {
      resize() {
        this.chart.resize();
      },
      renderChart() {
        // 基于准备好的dom，初始化echarts实例
        this.chart = echarts.init(this.$refs.singleProjectChart);
        // 绘制图表
        this.chart.setOption(this.option);
      },
    },
    beforeDestroy() {
      removeListener(this.$refs.singleProjectChart, this.resize);
      this.chart.dispose(); //销毁，防止内存泄漏
      this.chart = null;
    },
  }
</script>

<style scoped>

</style>