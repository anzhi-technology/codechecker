<template>
  <div>
    <a-card title="漏洞列表">
      <a-button size="small" slot="extra" style="background-color: #EDAE67; color: #fff" title="统计">
        <span class="yyIcon iconchart-area"></span></a-button>
      <a-row :gutter="8" type="flex" justify="center" align="middle">
        <a-col :span="8">
          <span>显示方式：</span>
        </a-col>
        <a-col :span="8">
          <a-select defaultValue="vuls" style="width: 120px" @change="handleChange">
            <a-select-option value="vuls">缺陷</a-select-option>
            <a-select-option value="files">文件</a-select-option>
          </a-select>
        </a-col>
      </a-row>
      <br/>
      <a-row type="flex" justify="center" align="middle">
        <a-col :span="24">
          <a-input-search
            placeholder="请输入关键字"
            @search="onSearch"
            enterButton
          />
        </a-col>
      </a-row>
      <br/>
      <a-row>
        <a-col :span="24">
          <a-tabs v-model="activeKey" size="small">
            <a-tab-pane key="1">
              <span slot="tab">
                 <span class="yyIcon iconbug-report" style="color: #f50;"></span>
                 <span style="color: #f50;">&nbsp;&nbsp;危</span>
              </span>
              <treeList v-if="selectedValue === 'vuls'"
                        :treeData="criticalTreeData"
                        :expandedKeys="expandedKeys"
                        :autoExpandParent="autoExpandParent"
                        ref="criticalChild"/>

              <treeList v-if="selectedValue === 'files'"
                        :treeData="criticalTreeDataByFile"
                        :expandedKeys="expandedKeys"
                        :autoExpandParent="autoExpandParent"
                        ref="criticalChild"/>
            </a-tab-pane>
            <a-tab-pane key="2">
              <span slot="tab">
                <span class="yyIcon iconbug-report" style="color: #EDAE67;"></span>
                <span style="color: #EDAE67;">&nbsp;&nbsp;高</span>
              </span>
              <treeList v-if="selectedValue === 'vuls'"
                        :treeData="highTreeData"
                        :expandedKeys="expandedKeys"
                        :autoExpandParent="autoExpandParent"
                        ref="highChild"/>

              <treeList v-if="selectedValue === 'files'"
                        :treeData="highTreeDataByFile"
                        :expandedKeys="expandedKeys"
                        :autoExpandParent="autoExpandParent"
                        ref="highChild"/>
            </a-tab-pane>
            <a-tab-pane key="3">
              <span slot="tab">
                 <span class="yyIcon iconbug-report" style="color: #108ee9;"></span>
                 <span style="color: #108ee9;">&nbsp;&nbsp;中</span>
              </span>
              <treeList v-if="selectedValue === 'vuls'"
                        :treeData="mediumTreeData"
                        :expandedKeys="expandedKeys"
                        :autoExpandParent="autoExpandParent"
                        ref="mediumChild"/>
              <treeList v-if="selectedValue === 'files'"
                        :treeData="mediumTreeDataByFile"
                        :expandedKeys="expandedKeys"
                        :autoExpandParent="autoExpandParent"
                        ref="mediumChild"/>
            </a-tab-pane>
            <a-tab-pane key="4">
              <span slot="tab">
                 <span class="yyIcon iconbug-report" style="color: #87d068;"></span>
                <span style="color: #87d068;">&nbsp;&nbsp;低</span>
              </span>
              <treeList v-if="selectedValue === 'vuls'"
                        :treeData="lowTreeData"
                        :expandedKeys="expandedKeys"
                        :autoExpandParent="autoExpandParent"
                        ref="lowChild"/>
              <treeList v-if="selectedValue === 'files'"
                        :treeData="lowTreeDataByFile"
                        :expandedKeys="expandedKeys"
                        :autoExpandParent="autoExpandParent"
                        ref="lowChild"/>
            </a-tab-pane>
            <a-tab-pane key="5">
              <span slot="tab">
                <span class="yyIcon iconbug-report"></span>
                <span>&nbsp;&nbsp;所有</span>
              </span>
              <treeList v-if="selectedValue === 'vuls'"
                        :treeData="allTreeData"
                        :expandedKeys="expandedKeys"
                        :autoExpandParent="autoExpandParent"
                        ref="allChild"/>
              <treeList v-if="selectedValue === 'files'"
                        :treeData="allTreeDataByFile"
                        :expandedKeys="expandedKeys"
                        :autoExpandParent="autoExpandParent"
                        ref="allChild"/>
            </a-tab-pane>
          </a-tabs>
        </a-col>
      </a-row>
    </a-card>
  </div>
</template>

<script>
  import treeList from "@/views/sourceCode/components/analyzeCode/treeList"
  import {getVulnerabilities} from "@/api/sourceCode/codeDetail"
  import _ from "underscore" //引入数据处理的分装方法

  export default {
    name: "vulnerabilityList",
    components: {
      treeList
    },
    data() {
      return {
        expandedKeys: [],
        autoExpandParent: true,
        selectedValue: 'vuls',
        activeKey:'1',
        //按type分
        criticalTreeData: [],
        highTreeData: [],
        mediumTreeData: [],
        lowTreeData: [],
        allTreeData: [],
        //按sourceFilePath分
        criticalTreeDataByFile: [],
        highTreeDataByFile: [],
        mediumTreeDataByFile: [],
        lowTreeDataByFile: [],
        allTreeDataByFile: [],
      }
    },
    created() {
      this.$nextTick(() => {
        this.getData();
      });
    },
    watch: {
      //监听相同路由下参数变化的时候，从而实现异步刷新
      '$route'(to, from) {
        //做一些路由变化的响应
        //重新获取数据
        this.getData();
      },
    },
    methods: {
      //获取数据
      getData() {
        this.loading = true;
        let projectId = this.$route.params.parameter; //获取路由上的参数
        return getVulnerabilities(projectId).then(res => {
          //通过type 的数据处理
          let allRankType = this.processDataByType(res.content);
          //危等级
          let criticalRankType = allRankType.filter(obj => obj.instanceSeverity === "4.0");
          this.criticalTreeData = criticalRankType.length === 0 ? [] : criticalRankType[0].children;
          //高等级
          let highRankType = allRankType.filter(obj => obj.instanceSeverity === "3.0");
          this.highTreeData = highRankType.length === 0 ? [] : highRankType[0].children;
          //中等级
          let mediumRankType = allRankType.filter(obj => obj.instanceSeverity === "2.0");
          this.mediumTreeData = mediumRankType.length === 0 ? [] : mediumRankType[0].children;
          //低等级
          let lowRankType = allRankType.filter(obj => obj.instanceSeverity === "1.0");
          this.lowTreeData = lowRankType.length === 0 ? [] : lowRankType[0].children;
          //所有
          this.allTreeData = _.union(this.criticalTreeData, this.highTreeData, this.mediumTreeData, this.lowTreeData);

          //通过sourceFilePath 的数据处理
          let allRankFile = this.processDataByFiles(res.content);
          //危等级
          let criticalRankFile = allRankFile.filter(obj => obj.instanceSeverity === "4.0");
          this.criticalTreeDataByFile = criticalRankFile.length === 0 ? [] : criticalRankFile[0].children;
          //高等级
          let highRankFile = allRankFile.filter(obj => obj.instanceSeverity === "3.0");
          this.highTreeDataByFile = highRankFile.length === 0 ? [] : highRankFile[0].children;
          //中等级
          let mediumRankFile = allRankFile.filter(obj => obj.instanceSeverity === "2.0");
          this.mediumTreeDataByFile = mediumRankFile.length === 0 ? [] : mediumRankFile[0].children;
          //低等级
          let lowRankFile = allRankFile.filter(obj => obj.instanceSeverity === "1.0");
          this.lowTreeDataByFile = lowRankFile.length === 0 ? [] : lowRankFile[0].children;
          //所有
          this.allTreeDataByFile = _.union(this.criticalTreeDataByFile, this.highTreeDataByFile, this.mediumTreeDataByFile, this.lowTreeDataByFile);

        });
      },
      /*显示方式*/
      handleChange(value) {
        this.selectedValue = value;
      },
      /*搜索框*/
      onSearch(value) {
        if(this.activeKey === '1') this.$refs.criticalChild.searchNode(value);
        if(this.activeKey === '2') this.$refs.highChild.searchNode(value);
        if(this.activeKey === '3') this.$refs.mediumChild.searchNode(value);
        if(this.activeKey === '4') this.$refs.lowChild.searchNode(value);
        if(this.activeKey === '5') this.$refs.allChild.searchNode(value);
      },
      /*通过Type处理请求到的数据*/
      processDataByType(data) {
        let a = _.groupBy(data, item => item.instanceSeverity); //按等级处理数据
        let newData = [];
        //遍历按等级处理的数据
        for (let item_instanceSeverity in a) {
          //开始将数据处理成符合vue Tree控件的数据
          let instanceSeverity = {"instanceSeverity": item_instanceSeverity, "children": []};
          let b = _.groupBy(a[item_instanceSeverity], obj => obj.type);
          for (let item_type in b) {
            let type = {
              type: item_type,
              title: item_type,
              key: _.random(0, 100) + item_type, //_.random(0, 100)为随机数 + {} 使key值唯一
              scopedSlots: {title: 'title'},
              selectable: false,
              children: []
            };
            let c = _.groupBy(b[item_type], obj => obj.subtype);
            for (let item_subtype in c) {
              let subtype = {
                subtype: item_subtype,
                title: item_subtype,
                key: _.random(0, 100) + item_subtype, //_.random(0, 100)为随机数 + {} 使key值唯一
                scopedSlots: {title: 'title'},
                selectable: false,
                children: []
              };
              let d = _.groupBy(c[item_subtype], obj => obj.sourceFilePath);
              let sourceFilePath;
              for (let item_sourceFilePath in d) {
                let sourceFile = item_sourceFilePath.split('/').pop();
                sourceFilePath = {
                  sourceFilePath: item_sourceFilePath,
                  title: sourceFile,
                  scopedSlots: {title: 'title'},
                  key: _.random(0, 100) + sourceFile, //_.random(0, 100)为随机数 + {} 使key值唯一
                  detail: []
                };
                sourceFilePath.detail = _.union(d[item_sourceFilePath]);
                if (item_subtype !== "null") {
                  subtype.children.push(sourceFilePath);
                } else {
                  type.children.push(sourceFilePath);
                }
              }
              if (item_subtype !== "null") type.children.push(subtype)
            }
            instanceSeverity.children.push(type)
          }
          newData.push(instanceSeverity)
        }
        return newData;
      },
      /*通过File处理请求到的数据*/
      processDataByFiles(data) {
        let a = _.groupBy(data, item => item.instanceSeverity); //按文件处理数据
        console.log(a);
        let newData = [];
        //遍历按等级处理的数据
        for (let item_instanceSeverity in a) {
          //开始将数据处理成符合vue Tree控件的数据
          let instanceSeverity = {"instanceSeverity": item_instanceSeverity, "children": []};
          let b = _.groupBy(a[item_instanceSeverity], obj => obj.sourceFilePath);
          for (let item_sourceFilePath in b) {
            let sourceFilePath = {
              sourceFilePath: item_sourceFilePath,
              title: item_sourceFilePath,
              key: _.random(0, 100) + item_sourceFilePath, //_.random(0, 100)为随机数 + {} 使key值唯一
              scopedSlots: {title: 'title'},
              selectable: false,
              children: []
            };
            let c = _.groupBy(b[item_sourceFilePath], obj => obj.type);
            for (let item_type in c) {
              let type = {
                type: item_type,
                title: item_type,
                scopedSlots: {title: 'title'},
                key: _.random(0, 100) + item_type, //_.random(0, 100)为随机数 + {} 使key值唯一
                detail: []
              };
              type.detail = _.union(c[item_type]);
              sourceFilePath.children.push(type);
            }
            instanceSeverity.children.push(sourceFilePath);
          }
          newData.push(instanceSeverity)
        }
        return newData;
      },
    }
  }
</script>

<style scoped>

</style>