<template>
  <div>
    <div v-show="highRiskData.length !== 0" ref="highRiskChart" style="height:200px;"></div>
    <div v-show="loading" style="height:200px;">
      <a-spin class="content"/>
    </div>
    <div v-show="visible" style="height: 200px; text-align:center; line-height:200px;"><h3>暂无数据</h3></div>
  </div>
</template>

<script>
import echarts from 'echarts'
// import debounce from 'lodash/debounce'   //防抖
import {addListener, removeListener} from 'resize-detector' //echart 位置
import {getDefectCount} from "@/api/sourceCode/overview"
import {isNull} from "@/utils/myUtils"

export default {
  name: "highRiskChart",
  data() {
    return {
      chart: null,
      highRiskData: [],
      nameData: [],
      criticalData: [],
      highData: [],
      mediumData: [],
      lowData: [],
      loading: true,
      visible: false
    }
  },
  mounted() {
    getDefectCount().then(res => {

      this.loading = false;
      let data = res.data;
      this.highRiskData = data;
      let lastData = [];
      //筛选最新的数据
      if (!isNull(data)) {
        data.forEach(item => {
          item.scanResult[0].name = item.name;
          item.scanResult[0].highRisk = item.scanResult[0].dangerous + item.scanResult[0].high;
          lastData.push(item.scanResult[0])
        });
        let grepData = lastData.filter(item => !isNull(item.all));   //筛选数据不为空的数据
        //grepData.reverse();                                        //颠倒数组元素
        grepData.sort((a, b) => b.highRisk - a.highRisk);             //排序筛选后的最新高危数据  由大到小

        let fiveHighRiskData = grepData.slice(0, 5);    //获取前5条数据
        fiveHighRiskData.reverse();

        fiveHighRiskData.forEach(item => {
          this.nameData.push(item.name);
          this.criticalData.push(item.dangerous);
          this.highData.push(item.high);
          this.mediumData.push(item.middle);
          this.lowData.push(item.low);
        });
      } else {
        this.visible = true;
      }

      this.option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: {            // 坐标轴指示器，坐标轴触发有效
            type: 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
          }
        },
        legend: {
          data: ['危', '高', '中', '低'],
          orient: 'vertical',
          x: 'left',
        },
        color: ['#c23531', '#d48265', '#2f4554', '#61a0a8'],
        grid: {
          left: '12%',
          top: "2%",
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'value'
        },
        yAxis: {
          type: 'category',
          data: this.nameData,
          axisLabel: {
            show: false
          }
        },
        series: [
          {
            name: '危',
            type: 'bar',
            stack: '总量',
            data: this.criticalData
          },
          {
            name: '高',
            type: 'bar',
            stack: '总量',
            data: this.highData
          },
          {
            name: '中',
            type: 'bar',
            stack: '总量',
            data: this.mediumData
          },
          {
            name: '低',
            type: 'bar',
            stack: '总量',
            data: this.lowData
          }
        ]
      };
      this.renderChart();
    });
  },
  methods: {
    resize() {
      this.chart.resize();
    },
    renderChart() {
      // 基于准备好的dom，初始化echarts实例
      this.chart = echarts.init(this.$refs.highRiskChart);
      addListener(this.$refs.highRiskChart, this.resize);
      // 绘制图表
      this.chart.setOption(this.option);
    },
  },
  beforeDestroy() {
    removeListener(this.$refs.highRiskChart, this.resize);
    this.chart.dispose();
    this.chart = null;
  },

}
</script>

<style scoped>
  .content {
    position: relative;
    left: 50%;
    top: 50%;
    -webkit-transform: translate(-50%, -50%);
    -ms-transform: translate(-50%, -50%);
    transform: translate(-50%, -50%);
  }
</style>